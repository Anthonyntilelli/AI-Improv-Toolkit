# --- Base ---
# apt update and upgrade {{DONE}}
# timedatectl set-timezone America/New_York {{DONE}}
# mkdir -p -m 0750 /opt/show {{DONE}}
# getent group show >/dev/null || addgroup --system --gid 495 show {{DONE}}
# getent group  >/dev/null || addgroup ssh-users {{DONE}}
# id -u show >/dev/null 2>&1 || adduser --system \
#   --home /opt/show \
#   --no-create-home \
#   --shell /usr/sbin/nologin \
#   --uid 495 --gid 495 \
#   --comment "Show runner account" \
#   show
^^ {{DONE}}
# usermod -aG ssh-users sysadmin {{DONE}}
# mkdir -p /opt/show/{setting,nats,pki,ingest,vision,hearing,brain,output} {{DONE}}

# chown root:show /opt/show {{DONE}}
# chmod 0750 /opt/show {{DONE}}

# chown root:root /opt/show/pki {{DONE}}
# chmod 0700 /opt/show/pki {{DONE}}

# chown show:show /opt/show/{setting,nats,ingest,vision,hearing,brain,output} {{DONE}}
# chmod 0750 /opt/show/{setting,nats,ingest,vision,hearing,brain,output} {{DONE}}
# install docker {{DONE}}

# # SSH is now on port 8022
# cat >/etc/ssh/sshd_config.d/10-harden-ssh.conf <<'EOF'
# Port 8022
# AuthenticationMethods publickey
# PubkeyAuthentication yes
# PasswordAuthentication no
# KbdInteractiveAuthentication no
# PermitRootLogin no
# AllowGroups ssh-users
# MaxAuthTries 3
# X11Forwarding no
# UsePAM yes
# EOF
# sshd -t && systemctl reload ssh {{DONE}}
# Remove authorized_keys on root {{DONE}}

# --- PKI Role ---
# investigate if pki folders are created with correct permissions
# If not run these commands:
  - infra/scripts/pki_manager.sh init and unzip tarball with certs/keys
  - check if certs are expired and renew if needed:
    - infra/scripts/pki_manager.sh rotate


# --- Physical Role ---
# Ensure laptop tasksel is active
# apt install -y timeshift jq rsync
# # RSYNC Exclude in file "/etc/timeshift/timeshift.json"
# : <<'COMMENT'
# "exclude": [
#   "/home/**",
#   "/root/.cache/**",
#   "/var/cache/**",
#   "/var/tmp/**",
#   "/var/log/journal/**",

#   "/var/lib/containerd/**",
#   "/opt/containerd/**",
#   "/opt/nri/**",

#   "/var/lib/docker/**",
#   "/var/lib/containers/**",

#   "/mnt/**",
#   "/media/**",

#   "/opt/show/**",
#   "/tmp/**"
# ]
# COMMENT

# timeshift --rsync
# jq --color-output . /etc/timeshift/timeshift.json

# cat >/etc/apt/apt.conf.d/50timeshift <<'EOF'
# DPkg::Pre-Invoke {
#   "timeshift --create --comments 'Before APT transaction' --tags D";
# };
# EOF

# apt install -y evtest vim alsa-utils \
# openssl pciutils usbutils \
# htop netcat-openbsd dnsutils \
# tr head awk grep \
# sed

# nmcli radio wifi on
# nmcli device status
# nmcli device wifi list
# nmcli device wifi connect "SSID" password "PASSWORD"
# nmcli connection modify "SSID" connection.autoconnect yes

# sudo mkdir -p --mode 755 /etc/ssh/authorized_keys
# install -m 0600 -o dev -g dev /home/sysadmin/.ssh/authorized_keys /etc/ssh/dev
# install -m 0600 -o sysadmin -g sysadmin /home/sysadmin/.ssh/authorized_keys /etc/ssh/sysadmin
# rm /home/sysadmin/.ssh/authorized_keys

# cat >/etc/ssh/sshd_config.d/20-fscrypt-friendly.conf <<'EOF'
# # Put authorized_keys outside encrypted homes (fscrypt-friendly)
# AuthorizedKeysFile /etc/ssh/authorized_keys/%u
# EOF
# sshd -t && systemctl reload ssh

# apt install -y firewalld sshguard

# firewall-cmd --set-default-zone=public
# firewall-cmd --permanent --add-port=8022/tcp
# firewall-cmd --permanent --zone=trusted --add-interface=docker0
# firewall-cmd --reload

# cat >/etc/default/sshguard <<EOF
# BACKEND="firewalld"
# EOF
# systemctl restart  sshguard

# systemctl enable --now firewalld
# systemctl enable --now sshguard

# systemctl status firewalld --no-pager
# systemctl status sshguard --no-pager

# apt install -y fscrypt libpam-fscrypt
# fscrypt status / # NOTE: MUST be yes
# fscrypt setup /
# # If dev Machine
# loginctl terminate-user dev
# fscrypt encrypt /home/dev --user=dev
# # You will be prompted to set a recovery passphrase → store it offline (password manager / vault).
# fscrypt status /home/dev

# timeshift --delete-all
# systemctl stop docker
# timeshift --create --comments "baseConfig" --yes --scripted
# systemctl start docker


# --- Dev ROLE  ---
# id -u dev >/dev/null 2>&1 || adduser dev
# usermod -aG show dev
# usermod -aG sudo dev
# usermod -aG ssh-users dev
# usermod -aG docker dev
# su - dev -c "docker run --rm hello-world"



# --- Ingest Role (require physical) ---
# apt install -y bluez
# systemctl enable --now bluetooth

# bluetoothctl <<'EOF'
# power on
# agent on
# default-agent
# scan on
# EOF

# # TODO: FIND MAC address
# bluetoothctl
# # in the interactive shell:
# pair AA:BB:CC:DD:EE:FF
# trust AA:BB:CC:DD:EE:FF
# connect AA:BB:CC:DD:EE:FF
# quit


# bluetoothctl <<EOF
# pairable on
# scan off
# discoverable off
# EOF


# #### TODO REAL VIP/UID
# cat <<'EOF' > /etc/tmpfiles.d/dev-show.conf
# d /dev/show 0755 root root -
# EOF

# systemd-tmpfiles --create


# cat >/etc/udev/rules.d/70-show-hid.rules <<EOF
# # USB actors (same VID/PID, distinguished by physical port)
# SUBSYSTEM=="hidraw", KERNEL=="hidraw*", ATTRS{idVendor}=="XXXX", ATTRS{idProduct}=="YYYY", KERNELS=="1-3", GROUP="show", MODE="0660", SYMLINK+="show/actor1"
# SUBSYSTEM=="hidraw", KERNEL=="hidraw*", ATTRS{idVendor}=="XXXX", ATTRS{idProduct}=="YYYY", KERNELS=="1-4", GROUP="show", MODE="0660", SYMLINK+="show/actor2"
# # Bluetooth device distinguished by uniq (MAC)
# SUBSYSTEM=="hidraw", KERNEL=="hidraw*", ENV{ID_BUS}=="bluetooth", ATTRS{uniq}=="AA:BB:CC:DD:EE:FF", GROUP="show", MODE="0660", SYMLINK+="show/bt-panic"
# # Fallback USB panic (VID/PID only) – consider adding a port match too if multiple exist
# SUBSYSTEM=="hidraw", KERNEL=="hidraw*", ATTRS{idVendor}=="XXXX", ATTRS{idProduct}=="YYYY", GROUP="show", MODE="0660", SYMLINK+="show/usb-panic"
# EOF

# cat > /etc/udev/rules.d/75-show-input-ignore.rules <<'EOF'
# # For the keyboard-emulating HID(s): prevent desktop uaccess ACLs, restrict permissions,
# # and also tell libinput to ignore (Wayland/X won't treat it as a keyboard).
# SUBSYSTEM=="input", KERNEL=="event*", ATTRS{idVendor}=="XXXX", ATTRS{idProduct}=="YYYY", GROUP="show", MODE="0660", TAG-="uaccess", TAG-="seat", ENV{LIBINPUT_IGNORE_DEVICE}="1"
# #TODO OTHER 3 inputs
# EOF

# udevadm control --reload-rules
# udevadm trigger

# ls -l /dev/show/
